<!DOCTYPE html>
<html class="scroll-smooth" lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   Advisory Report | YieldWise
  </title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com">
  </script>
  <link href="style.css" rel="stylesheet"/>
  <link href="advisory_report.css" rel="stylesheet"/>
  <link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-ozB3YcE4mY3+U8fJH8W6W6uZ8mQjv8cZk2e1E3fK1FQbJ9bF+M3bA4o4lBvJ2y4dYlVwC2QWQk6q4k1w1H3GQ==" referrerpolicy="no-referrer" rel="stylesheet">
   <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11">
   </script>
   <script src="https://cdn.jsdelivr.net/npm/apexcharts">
   </script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
   </script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js">
   </script>
   <style>
    body { font-family: 'Poppins', sans-serif; }
   </style>
  </link>
 
<!-- CSS Loader Script -->
<script src="./css_loader.js"></script>
</head>
 <body class="bg-gray-50 text-gray-800">
  <!-- Header (use provided component as-is) -->
  <header class="w-full bg-white border-b border-[#2E7D32] sticky top-0 z-50">
   <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex h-16 items-center justify-between">
     <div class="flex items-center gap-3">
      <img alt="YeildWise" class="h-9 w-auto" onerror="this.onerror=null;this.src='src='//ibb.co/JW4DnZwH'" src="https://i.ibb.co/p68Y2qBd/Logo-02.png"'" src="/project/692afde4b2e243410cabae6d/logos/logo_dbb8369b-d721-4b7b-b957-1a93dae384eb.png"/>
      <span class="text-xl font-semibold text-[#2E7D32]">
       Smart Advisory
      </span>
     </div>
     <div class="flex-1 max-w-lg mx-6 hidden md:block">
      <div class="relative">
       <input class="w-full border border-gray-300 rounded-md pl-10 pr-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-[#2E7D32] focus:border-[#2E7D32]" placeholder="Search crops, fertilizers..." type="text"/>
       <i class="fas fa-search absolute left-3 top-2.5 text-gray-400">
       </i>
      </div>
     </div>
     <div class="flex items-center gap-2">
      <a class="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-[#2E7D32] rounded-md hover:opacity-90" href="#advisory_report?action=export" id="headerExportBtn">
       <i class="fas fa-file-pdf">
       </i>
       Export PDF
      </a>
      <a class="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-[#2E7D32] rounded-md hover:opacity-90" href="#advisory_report?action=save" id="headerSaveBtn">
       <i class="fas fa-save">
       </i>
       Save to Profile
      </a>
      <button class="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-[#2E7D32] bg-green-50 border border-[#2E7D32] rounded-md hover:bg-green-100" id="headerReadBtn" title="Read Aloud">
       <i class="fas fa-volume-up">
       </i>
       Read Aloud
      </button>
      <button class="p-2 rounded hover:bg-gray-100" title="Notifications">
       <i class="fas fa-bell text-gray-700">
       </i>
      </button>
      <details class="relative">
       <summary class="list-none cursor-pointer flex items-center gap-2">
        <img alt="User" class="h-8 w-8 rounded-full" onerror="this.onerror=null;this.src='https://ibb.co/RpZL1PWH'" src="https://i.ibb.co/XZNm9pTJ/Default-male-avatar.webp"/>
        <span class="text-sm text-gray-700">
         Farmer
        </span>
        <i class="fas fa-chevron-down text-gray-500">
        </i>
       </summary>
       <div class="absolute right-0 mt-2 w-52 bg-white border border-gray-200 rounded-md shadow-lg">
        <a class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50" href="./farmer_profile.html">
         <i class="fas fa-user mr-2">
         </i>
         Profile
        </a>
        <a class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50" href="./home_dashboard.html">
         <i class="fas fa-home mr-2">
         </i>
         Home
        </a>
        <div class="border-t border-gray-200">
        </div>
        <a class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50" href="#">
         <i class="fas fa-sign-out-alt mr-2">
         </i>
         Logout
        </a>
       </div>
      </details>
     </div>
    </div>
   </div>
  </header>
  <!-- Main Layout: Sidebar + Content -->
  <div class="main-container">
   <div class="max-w-7xl mx-auto">
    <div class="flex">
     <!-- Sidebar (use provided component, apply active state for current page) -->
     <aside class="hidden md:block w-64 bg-white border-r border-gray-200 min-h-screen pt-4 px-2" id="sidebar-advisory">
      <nav class="space-y-2">
       <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase">
        Advisory Workflow
       </h3>
       <a class="group flex items-center gap-3 px-3 py-2 text-gray-700 rounded-md hover:bg-green-50 hover:text-[#2E7D32]" href="./smart_advisory.html">
        <i class="fas fa-clipboard-list text-[#2E7D32]">
        </i>
        <span>
         Smart Advisory Form
        </span>
       </a>
       <a aria-current="page" class="group flex items-center gap-3 px-3 py-2 rounded-md bg-green-50 text-[#2E7D32] font-medium" href="./advisory_report.html">
        <i class="fas fa-file-alt text-[#2E7D32]">
        </i>
        <span>
         Advisory Report
        </span>
       </a>
       <details class="px-3 py-2 rounded-md">
        <summary class="flex items-center gap-3 cursor-pointer text-gray-700 hover:text-[#2E7D32]">
         <i class="fas fa-folder-open text-[#2E7D32]">
         </i>
         <span>
          Reports
         </span>
        </summary>
        <div class="mt-2 ml-6 space-y-1">
         <a class="block px-2 py-1 text-sm text-gray-600 hover:text-[#2E7D32]" href="./farmer_profile.html">
          <i class="fas fa-list mr-2">
          </i>
          Saved Reports
         </a>
         <a class="block px-2 py-1 text-sm text-gray-600 hover:text-[#2E7D32]" href="./advisory_report.html">
          <i class="fas fa-file-pdf mr-2">
          </i>
          Export to PDF
         </a>
        </div>
       </details>
       <a class="group flex items-center gap-3 px-3 py-2 text-gray-700 rounded-md hover:bg-green-50 hover:text-[#2E7D32]" href="./home_dashboard.html">
        <i class="fas fa-home text-[#2E7D32]">
        </i>
        <span>
         Back to Home
        </span>
       </a>
      </nav>
     </aside>
     <!-- Content -->
     <main class="flex-1 p-4 md:p-6">
      <!-- Advisory Report Display -->
      <section class="space-y-6" id="AdvisoryReportDisplay">
       <!-- Report Header -->
       <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="p-4 md:p-6">
         <h1 class="text-2xl md:text-3xl font-semibold text-[#2E7D32]">
          Your Smart Advisory Report
         </h1>
         <p class="mt-2 text-sm md:text-base text-gray-700" id="userInputSummary">
          Generated for: State - [State], District - [District], Soil - [Soil Type], Season - [Season]
         </p>
         <div class="mt-3 text-xs text-gray-500">
          Last updated:
          <span id="lastUpdated">
           —
          </span>
         </div>
        </div>
       </div>
       <!-- System Feedback Area -->
       <div class="hidden alert-info border rounded-md p-3 text-sm" id="systemFeedback">
       </div>
       <!-- Recommendations Section Container -->
       <div class="space-y-6" id="report-content">
        <!-- Crop Recommendations -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
         <div class="p-4 md:p-6">
          <div class="flex items-center justify-between">
           <h2 class="text-xl font-semibold text-gray-800">
            Recommended Crops
           </h2>
           <div class="flex items-center gap-2">
            <label class="text-sm text-gray-600">
             Filter
            </label>
            <select class="form-select border-gray-300 rounded-md text-sm" id="cropFilter">
             <option value="all">
              All
             </option>
             <option value="cereal">
              Cereals
             </option>
             <option value="legume">
              Legumes
             </option>
             <option value="vegetable">
              Vegetables
             </option>
             <option value="cash">
              Cash Crops
             </option>
            </select>
           </div>
          </div>
          <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="cropCards">
          </div>
         </div>
        </div>
        <!-- Fertilizer Suggestions Table -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
         <div class="p-4 md:p-6">
          <div class="flex items-center justify-between">
           <h2 class="text-xl font-semibold text-gray-800">
            Fertilizer Plan
           </h2>
           <div class="flex items-center gap-2">
            <input class="border border-gray-300 rounded-md px-3 py-1 text-sm w-48" id="fertSearch" placeholder="Search type or crop" type="text">
             <select class="border border-gray-300 rounded-md px-2 py-1 text-sm" id="fertTypeFilter">
              <option value="all">
               All Types
              </option>
              <option value="N">
               Nitrogen (N)
              </option>
              <option value="P">
               Phosphorus (P)
              </option>
              <option value="K">
               Potassium (K)
              </option>
              <option value="Micronutrient">
               Micronutrient
              </option>
             </select>
            </input>
           </div>
          </div>
          <div class="mt-4 overflow-x-auto">
           <table class="min-w-full text-sm">
            <thead class="table-header">
             <tr>
              <th class="px-3 py-2 text-left cursor-pointer" data-sort="crop">
               Crop
               <i class="fas fa-sort ml-1 text-gray-400">
               </i>
              </th>
              <th class="px-3 py-2 text-left cursor-pointer" data-sort="type">
               Type
               <i class="fas fa-sort ml-1 text-gray-400">
               </i>
              </th>
              <th class="px-3 py-2 text-left cursor-pointer" data-sort="quantity">
               Quantity (kg/acre)
               <i class="fas fa-sort ml-1 text-gray-400">
               </i>
              </th>
              <th class="px-3 py-2 text-left cursor-pointer" data-sort="schedule">
               Schedule
               <i class="fas fa-sort ml-1 text-gray-400">
               </i>
              </th>
              <th class="px-3 py-2 text-left">
               Method
              </th>
              <th class="px-3 py-2 text-left">
               Actions
              </th>
             </tr>
            </thead>
            <tbody class="table-striped" id="fertTableBody">
            </tbody>
           </table>
          </div>
          <div class="mt-3 flex items-center justify-between text-xs text-gray-600">
           <div>
            Rows per page: 5
           </div>
           <div class="flex items-center gap-3">
            <button class="px-2 py-1 border rounded" id="fertPrev">
             Prev
            </button>
            <span id="fertPageInfo">
             Page 1 of 1
            </span>
            <button class="px-2 py-1 border rounded" id="fertNext">
             Next
            </button>
           </div>
          </div>
         </div>
        </div>
        <!-- Irrigation Frequency Info -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
         <div class="p-4 md:p-6">
          <h2 class="text-xl font-semibold text-gray-800">
           Irrigation Advisory
          </h2>
          <p class="mt-2 text-gray-700" id="irrigationText">
           Loading irrigation guidance...
          </p>
          <!-- Apex Chart: Watering Schedule Visualization -->
          <div class="mt-4">
           <div class="w-full" id="waterScheduleChart">
           </div>
          </div>
         </div>
        </div>
        <!-- Pest Risk List -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
         <div class="p-4 md:p-6">
          <div class="flex items-center justify-between">
           <h2 class="text-xl font-semibold text-gray-800">
            Pest Risks &amp; Mitigation
           </h2>
           <span class="badge-warning px-2 py-1 rounded">
            Region Update
           </span>
          </div>
          <ul class="mt-3 space-y-2" id="pestList">
          </ul>
          <!-- Apex Chart: Pest Severity Distribution -->
          <div class="mt-4">
           <div id="pestSeverityChart">
           </div>
          </div>
         </div>
        </div>
        <!-- Notes & Disclaimers -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
         <div class="p-4 md:p-6">
          <h3 class="text-lg font-semibold text-gray-800">
           Notes
          </h3>
          <ul class="mt-2 text-sm text-gray-700 list-disc pl-5">
           <li>
            Recommendations are indicative. Consult local agri experts for precise actions.
           </li>
           <li>
            Weather conditions can change rapidly; monitor forecasts regularly.
           </li>
           <li>
            Use quality seeds and certified inputs for best results.
           </li>
          </ul>
         </div>
        </div>
       </div>
      </section>
      <!-- Report Actions: sticky on mobile -->
      <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-3 shadow-lg" id="ReportActions">
       <div class="flex items-center justify-around">
        <button class="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-[#2E7D32] rounded-md" id="mobileExportBtn">
         <i class="fas fa-file-pdf">
         </i>
         Export PDF
        </button>
        <button class="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-[#2E7D32] rounded-md" id="mobileSaveBtn">
         <i class="fas fa-save">
         </i>
         Save
        </button>
        <button class="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-[#2E7D32] bg-green-50 border border-[#2E7D32] rounded-md" id="mobileReadBtn">
         <i class="fas fa-volume-up">
         </i>
         Read
        </button>
       </div>
      </div>
     </main>
    </div>
   </div>
  </div>
  <!-- Footer (use provided component as-is) -->
  <footer class="w-full bg-white border-t border-gray-200">
   <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
    <div class="flex items-center gap-2">
     <img alt="Logo" class="h-5 w-5" onerror="this.onerror=null;this.src='https://ibb.co/JW4DnZwH'" src="https://i.ibb.co/p68Y2qBd/Logo-02.png"/>
     <span class="text-sm text-gray-600">
      Advisory Suite
     </span>
    </div>
    <div class="flex items-center gap-4">
     <a class="text-sm text-gray-600 hover:text-[#2E7D32]" href="./smart_advisory.html">
      <i class="fas fa-clipboard-list mr-1">
      </i>
      Form
     </a>
     <a class="text-sm text-gray-600 hover:text-[#2E7D32]" href="./advisory_report.html">
      <i class="fas fa-file-alt mr-1">
      </i>
      Report
     </a>
     <a class="text-sm text-gray-600 hover:text-[#2E7D32]" href="./advisory_report.html">
      <i class="fas fa-file-pdf mr-1">
      </i>
      Export
     </a>
     <span class="mx-2 text-gray-300">
      |
     </span>
     <a class="text-sm text-gray-600 hover:text-[#2E7D32]" href="./language_selection.html">
      Terms
     </a>
     <a class="text-sm text-gray-600 hover:text-[#2E7D32]" href="./language_selection.html">
      Privacy
     </a>
    </div>
   </div>
  </footer>
  <!-- Scripts -->
  <script>
   // Sample/Mock report data (used if no data in localStorage)
const sampleReport = {
    state: 'Maharashtra',
    district: 'Pune',
    soilType: 'Loamy',
    season: 'Kharif',
    crops: [{
        name: 'Maize',
        type: 'cereal',
        season: 'Kharif',
        description: 'High-yield cereal suitable for loamy soil.',
        suitability: 0.88,
        image: 'https://i.ibb.co/0VdfWnt4/download.jpg '
    }, {
        name: 'Soybean',
        type: 'legume',
        season: 'Kharif',
        description: 'Protein-rich legume improving soil nitrogen.',
        suitability: 0.82,
        image: 'https://i.ibb.co/wrNg8cq9/images.jpg'
    }, {
        name: 'Groundnut',
        type: 'legume',
        season: 'Kharif',
        description: 'Oilseed crop with good market demand.',
        suitability: 0.79,
        image: 'https://i.ibb.co/btbTGbN/blog-3.webp'
    }, {
        name: 'Tomato',
        type: 'vegetable',
        season: 'Rabi',
        description: 'Popular vegetable with short growing cycle.',
        suitability: 0.74,
        image: 'https://i.ibb.co/bgBsrpMb/tomatoes-tomato-plant-Fruit-vegetable.webp'
    }, {
        name: 'Cotton',
        type: 'cash',
        season: 'Kharif',
        description: 'Cash crop with improved cultivars.',
        suitability: 0.7,
        image: 'https://i.ibb.co/5Wf5bndW/cotton-4220654-640.jpg'
    }],
    fertilizers: [{
        crop: 'Maize',
        type: 'N',
        quantity: 60,
        schedule: 'Basal (Day 0)',
        method: 'Broadcast'
    }, {
        crop: 'Maize',
        type: 'P',
        quantity: 30,
        schedule: 'Basal (Day 0)',
        method: 'Band placement'
    }, {
        crop: 'Maize',
        type: 'K',
        quantity: 30,
        schedule: 'Top dress (Day 30)',
        method: 'Side dressing'
    }, {
        crop: 'Soybean',
        type: 'Micronutrient',
        quantity: 5,
        schedule: 'Foliar (Day 25)',
        method: 'Spray'
    }, {
        crop: 'Groundnut',
        type: 'N',
        quantity: 20,
        schedule: 'Top dress (Day 20)',
        method: 'Broadcast'
    }, {
        crop: 'Tomato',
        type: 'K',
        quantity: 40,
        schedule: 'Split (Day 20 & 40)',
        method: 'Fertigation'
    }, {
        crop: 'Cotton',
        type: 'P',
        quantity: 25,
        schedule: 'Basal (Day 0)',
        method: 'Band placement'
    }],
    irrigationText: 'For loamy soils in Kharif, irrigate maize every 7–10 days depending on rainfall. Use furrow irrigation for row crops. Ensure 35–45 mm per irrigation event. Drip is recommended for tomato: 1–1.5 L/hr per dripper, 60–90 min cycles.',
    pests: [{
        name: 'Fall Armyworm',
        severity: 'High',
        mitigation: 'Monitor traps weekly; apply Bacillus thuringiensis or Emamectin as per label.'
    }, {
        name: 'Stem Borer',
        severity: 'Medium',
        mitigation: 'Use pheromone traps and timely irrigation to reduce stress.'
    }, {
        name: 'Aphids',
        severity: 'Medium',
        mitigation: 'Neem oil 2% spray; encourage ladybird beetles.'
    }, {
        name: 'Whitefly',
        severity: 'Low',
        mitigation: 'Yellow sticky traps; avoid indiscriminate sprays.'
    }]
};

const state = {
    isLoading: true,
    sortKey: 'crop',
    sortAsc: true,
    fertPage: 1,
    rowsPerPage: 5,
    isReading: false,
    utterance: null
};

function loadReport() {
    // Load from localStorage if available
    const savedInput = JSON.parse(localStorage.getItem('smartAdvisoryInput') || 'null');
    const savedReport = JSON.parse(localStorage.getItem('currentAdvisoryReport') || 'null');
    const report = savedReport || sampleReport;
    const input = savedInput || {
        state: report.state,
        district: report.district,
        soilType: report.soilType,
        season: report.season
    };
    renderHeader(input);
    renderCrops(report.crops);
    renderFertilizers(report.fertilizers);
    renderIrrigation(report.irrigationText);
    renderPests(report.pests);
    renderCharts(report);
    state.isLoading = false;
}

function renderHeader(input) {
    document.getElementById('userInputSummary').textContent = `Generated for: State - ${input.state}, District - ${input.district}, Soil - ${input.soilType}, Season - ${input.season}`;
    document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
}

// Crop Cards
let allCrops = [];

function renderCrops(crops) {
    allCrops = crops;
    const container = document.getElementById('cropCards');
    container.innerHTML = '';
    crops.forEach(c => {
        const card = document.createElement('div');
        card.className = 'card border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition-shadow';
        card.innerHTML = `
          <img src="${c.image}" alt="${c.name}" class="w-full h-36 object-cover" onerror="this.onerror=null;this.src='https://picsum.photos/seed/${encodeURIComponent(c.name)}/300/180'">
          <div class="p-3">
            <div class="flex items-center justify-between mb-1">
              <h3 class="text-lg font-semibold text-gray-800">${c.name}</h3>
              <span class="badge-success px-2 py-0.5 rounded text-xs">${(c.suitability * 100).toFixed(0)}% fit</span>
            </div>
            <p class="text-sm text-gray-700">${c.description}</p>
            <div class="mt-2 flex items-center justify-between text-xs text-gray-600">
              <span class="badge-info px-2 py-0.5 rounded">${c.type}</span>
              <span class="">Season: ${c.season}</span>
            </div>
          </div>
        `;
        container.appendChild(card);
    });
}

document.getElementById('cropFilter').addEventListener('change', (e) => {
    const val = e.target.value;
    const filtered = val === 'all' ? allCrops : allCrops.filter(c => c.type === val);
    renderCrops(filtered);
});

// Fertilizer Table
let fertData = [];

function renderFertilizers(data) {
    fertData = data.slice();
    applyFertFiltersAndRender();
}

function applyFertFiltersAndRender() {
    const search = document.getElementById('fertSearch').value.toLowerCase();
    const typeFilter = document.getElementById('fertTypeFilter').value;
    let rows = fertData.filter(r => {
        const matchesSearch = r.crop.toLowerCase().includes(search) || r.type.toLowerCase().includes(search);
        const matchesType = typeFilter === 'all' ? true : r.type === typeFilter;
        return matchesSearch && matchesType;
    });
    rows.sort((a, b) => {
        const key = state.sortKey;
        const av = a[key];
        const bv = b[key];
        if (typeof av === 'string') {
            if (state.sortAsc) return av.localeCompare(bv);
            else return bv.localeCompare(av);
        } else {
            if (state.sortAsc) return av - bv;
            else return bv - av;
        }
    });
    paginateFert(rows);
}

function paginateFert(rows) {
    const totalPages = Math.max(1, Math.ceil(rows.length / state.rowsPerPage));
    if (state.fertPage > totalPages) state.fertPage = totalPages;
    const start = (state.fertPage - 1) * state.rowsPerPage;
    const pageRows = rows.slice(start, start + state.rowsPerPage);
    const tbody = document.getElementById('fertTableBody');
    tbody.innerHTML = '';
    pageRows.forEach(r => {
        const tr = document.createElement('tr');
        tr.className = 'table-row';
        tr.innerHTML = `
          <td class="px-3 py-2">${r.crop}</td>
          <td class="px-3 py-2">${r.type}</td>
          <td class="px-3 py-2">${r.quantity.toFixed(0)}</td>
          <td class="px-3 py-2">${r.schedule}</td>
          <td class="px-3 py-2">${r.method}</td>
          <td class="px-3 py-2">
            <button class="btn-outline px-2 py-1 rounded text-xs" onclick="showFertInfo('${r.crop}', '${r.type}', '${r.schedule}')"><i class="fas fa-info-circle"></i> Details</button>
          </td>
        `;
        tbody.appendChild(tr);
    });
    document.getElementById('fertPageInfo').textContent = `Page ${state.fertPage} of ${totalPages}`;
    document.getElementById('fertPrev').disabled = state.fertPage === 1;
    document.getElementById('fertNext').disabled = state.fertPage === totalPages;
}

function showFertInfo(crop, type, schedule) {
    Swal.fire({
        icon: 'info',
        title: 'Fertilizer Details',
        html: `<div class="text-left"><p><strong>Crop:</strong> ${crop}</p><p><strong>Type:</strong> ${type}</p><p><strong>Schedule:</strong> ${schedule}</p><p class="mt-2 text-gray-600 text-sm">Follow local recommendations and label instructions. Ensure proper moisture during application.</p></div>`,
        confirmButtonColor: '#2E7D32'
    });
}

document.getElementById('fertSearch').addEventListener('input', applyFertFiltersAndRender);
document.getElementById('fertTypeFilter').addEventListener('change', applyFertFiltersAndRender);
document.querySelectorAll('thead th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
        const key = th.getAttribute('data-sort');
        if (state.sortKey === key) state.sortAsc = !state.sortAsc;
        else {
            state.sortKey = key;
            state.sortAsc = true;
        }
        applyFertFiltersAndRender();
    });
});
document.getElementById('fertPrev').addEventListener('click', () => {
    state.fertPage = Math.max(1, state.fertPage - 1);
    applyFertFiltersAndRender();
});
document.getElementById('fertNext').addEventListener('click', () => {
    state.fertPage = state.fertPage + 1;
    applyFertFiltersAndRender();
});

// Irrigation
function renderIrrigation(text) {
    document.getElementById('irrigationText').textContent = text;
}

// Pests
function renderPests(pests) {
    const list = document.getElementById('pestList');
    list.innerHTML = '';
    pests.forEach(p => {
        const li = document.createElement('li');
        li.className = 'border border-gray-200 rounded-md p-3 flex items-start justify-between';
        const severityClass = p.severity === 'High' ? 'badge-danger' : p.severity === 'Medium' ? 'badge-warning' : 'badge-success';
        li.innerHTML = `
          <div>
            <div class="font-medium text-gray-800">${p.name}</div>
            <div class="mt-1 text-sm text-gray-700">${p.mitigation}</div>
          </div>
          <span class="${severityClass} px-2 py-1 rounded text-xs">${p.severity}</span>
        `;
        list.appendChild(li);
    });
}

// Charts (ApexCharts)
function renderCharts(report) {
    // Watering schedule (weekly mm)
    const waterOptions = {
        chart: {
            type: 'line',
            height: 260,
            toolbar: {
                show: false
            }
        },
        series: [{
            name: 'Irrigation (mm)',
            data: [40, 0, 35, 45, 20, 30, 0, 40]
        }],
        xaxis: {
            categories: ['W1', 'W2', 'W3', 'W4', 'W5', 'W6', 'W7', 'W8']
        },
        colors: ['#2E7D32'],
        stroke: {
            width: 3
        },
        markers: {
            size: 4
        },
        tooltip: {
            theme: 'light'
        }
    };
    try {
        new ApexCharts(document.querySelector('#waterScheduleChart'), waterOptions).render();
    } catch (e) {
        console.warn('Apex chart failed:', e);
    }

    // Pest severity
    const severityCounts = {
        High: 0,
        Medium: 0,
        Low: 0
    };
    report.pests.forEach(p => severityCounts[p.severity] = (severityCounts[p.severity] || 0) + 1);
    const pestOptions = {
        chart: {
            type: 'bar',
            height: 260,
            toolbar: {
                show: false
            }
        },
        series: [{
            data: [severityCounts.High || 0, severityCounts.Medium || 0, severityCounts.Low || 0]
        }],
        xaxis: {
            categories: ['High', 'Medium', 'Low']
        },
        colors: ['#dc2626', '#f59e0b', '#16a34a'],
        tooltip: {
            theme: 'light'
        }
    };
    try {
        new ApexCharts(document.querySelector('#pestSeverityChart'), pestOptions).render();
    } catch (e) {
        console.warn('Apex chart failed:', e);
    }
}

// Save to Profile
function saveReport() {
    try {
        const reportToSave = JSON.parse(localStorage.getItem('currentAdvisoryReport') || 'null') || sampleReport;
        const saved = JSON.parse(localStorage.getItem('savedReports') || '[]');
        saved.push({
            id: Date.now(),
            title: 'Advisory Report',
            date: new Date().toISOString(),
            report: reportToSave
        });
        localStorage.setItem('savedReports', JSON.stringify(saved));
        Swal.fire({
            icon: 'success',
            title: 'Report Saved!',
            timer: 1500,
            showConfirmButton: false
        });
    } catch (e) {
        Swal.fire({
            icon: 'error',
            title: 'Save Failed',
            text: e.message
        });
    }
}

// Export PDF using jsPDF + html2canvas
async function exportPDF() {
    const {
        jsPDF
    } = window.jspdf;
    const reportEl = document.getElementById('report-content');
    const canvas = await html2canvas(reportEl, {
        scale: 2
    });
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgProps = {
        width: pageWidth,
        height: canvas.height * pageWidth / canvas.width
    };
    let y = 0;
    let remainingHeight = imgProps.height;
    while (remainingHeight > 0) {
        pdf.addImage(imgData, 'PNG', 0, y, imgProps.width, imgProps.height);
        remainingHeight -= pageHeight;
        if (remainingHeight > 0) {
            pdf.addPage();
            y = 0; // reset y on new page
        }
    }
    pdf.save('Smart_Advisory_Report.pdf');
}

// Read Aloud (Web Speech API)
function startReadAloud() {
    const text = document.getElementById('report-content').innerText;
    if (!('speechSynthesis' in window)) {
        return Swal.fire({
            icon: 'warning',
            title: 'Not Supported',
            text: 'Speech synthesis not supported in this browser.'
        });
    }
    if (!state.utterance) {
        state.utterance = new SpeechSynthesisUtterance(text);
        state.utterance.lang = 'en-IN';
        state.utterance.rate = 1.0;
        state.utterance.onend = () => {
            state.isReading = false;
            updateReadButtons();
        };
    }
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(state.utterance);
    state.isReading = true;
    updateReadButtons();
}

function toggleReadAloud() {
    if (!('speechSynthesis' in window)) return;
    if (state.isReading) {
        window.speechSynthesis.pause();
        state.isReading = false;
    } else {
        window.speechSynthesis.resume();
        state.isReading = true;
    }
    updateReadButtons();
}

function updateReadButtons() {
    const btns = [document.getElementById('headerReadBtn'), document.getElementById('mobileReadBtn')];
    btns.forEach(btn => {
        if (!btn) return;
        btn.innerHTML = state.isReading ? '<i class="fas fa-pause"></i> Pause' : '<i class="fas fa-volume-up"></i> Read Aloud';
    });
}

// Button bindings
function bindActions() {
    document.getElementById('headerSaveBtn').addEventListener('click', (e) => {
        e.preventDefault();
        saveReport();
    });
    document.getElementById('headerExportBtn').addEventListener('click', (e) => {
        e.preventDefault();
        exportPDF();
    });
    document.getElementById('headerReadBtn').addEventListener('click', (e) => {
        e.preventDefault();
        if (!state.isReading) startReadAloud();
        else toggleReadAloud();
    });
    document.getElementById('mobileSaveBtn').addEventListener('click', saveReport);
    document.getElementById('mobileExportBtn').addEventListener('click', exportPDF);
    document.getElementById('mobileReadBtn').addEventListener('click', () => {
        if (!state.isReading) startReadAloud();
        else toggleReadAloud();
    });
}

document.addEventListener('DOMContentLoaded', () => {
    loadReport();
    bindActions();
});
  </script>
  <!-- Page-specific CSS (place into advisory_report.css file) -->
  <!--
  /* advisory_report.css */
  .main-container { background-color: var(--surface-bg); }
  #AdvisoryReportDisplay .card:hover { transform: translateY(-2px); transition: transform 200ms ease; }
  @media print {
    header, footer, #ReportActions, #sidebar-advisory { display: none !important; }
    body { background: #fff; }
    #AdvisoryReportDisplay { margin: 0; padding: 0; }
  }
  -->
 </body>
</html>
