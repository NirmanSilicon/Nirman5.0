<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Fin-Forge Demo â€” Behavioral Engine</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <style>
        /* Dark neon theme - compact for demo */
        :root {
            --bg: #071018;
            --card: #0f1a23;
            --accent: #ff9f1c;
            --muted: #9aa6b2;
            --glow: 0 6px 30px rgba(255, 159, 28, 0.12);
        }

        body {
            background: linear-gradient(180deg, #04060a 0%, #071018 60%);
            color: #e6eef6;
            font-family: Inter, system-ui, Arial;
            margin: 0;
            padding: 28px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 28px;
        }

        header {
            grid-column: 1/-1;
            text-align: center;
            margin-bottom: 6px;
        }

        h1 {
            font-size: 48px;
            margin: 6px 0;
            color: linear-gradient(#ffb86b, #ff6a00);
        }

        .hero {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            padding: 18px;
            box-shadow: var(--glow);
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(0, 0, 0, 0.08));
            border: 1px solid rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 14px;
        }

        .left .stage {
            height: 380px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .event-box {
            flex: 1;
            border-radius: 10px;
            background: linear-gradient(180deg, #071728, #081723);
            padding: 14px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .event-title {
            font-size: 18px;
            color: var(--accent);
            font-weight: 600;
        }

        .event-sub {
            color: var(--muted);
            margin-top: 6px;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            justify-content: center;
        }

        button.action {
            background: var(--accent);
            border: none;
            color: #071018;
            padding: 12px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            box-shadow: var(--glow);
        }

        button.safe {
            background: #2dd4bf;
            color: #052024;
        }

        .small {
            font-size: 13px;
            color: var(--muted)
        }

        .metrics {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            align-items: center;
        }

        .metric {
            background: rgba(0, 0, 0, 0.25);
            padding: 8px 12px;
            border-radius: 8px;
            min-width: 90px;
            text-align: center;
        }

        .right {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .analytics {
            height: 220px;
            padding: 16px;
        }

        .bar {
            height: 14px;
            background: #071a21;
            border-radius: 12px;
            overflow: hidden;
            margin: 8px 0;
            position: relative;
        }

        .bar > i {
            display: block;
            height: 100%;
            background: linear-gradient(90deg, #00c2ff, #ffb86b);
            width: 10%;
        }

        .badge {
            background: #0b2730;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .badge .dot {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: linear-gradient(180deg, #ffb86b, #ff7a00);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #071018
        }

        .result {
            margin-top: 10px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px
        }

        footer {
            grid-column: 1/-1;
            color: var(--muted);
            margin-top: 14px;
            text-align: center;
        }

        .controls2 {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
            justify-content: center;
        }

        input[type="range"] {
            width: 140px;
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .forge-row {
            display: flex;
            gap: 12px;
            margin-top: 14px;
        }

        .forge {
            flex: 1;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), rgba(0, 0, 0, 0.06));
            padding: 12px;
            border-radius: 12px;
            text-align: center
        }

        .bigbtn {
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(90deg, #ffb86b, #ff7a00);
            font-weight: 700;
            color: #071018;
            cursor: pointer;
            box-shadow: var(--glow)
        }

        pre {
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 13px
        }

        @media (max-width: 980px) {
            .container {
                grid-template-columns:1fr;
            }

            .right {
                order: 2
            }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1 style="color: #ffb86b">FIN-FORGE</h1>
        <div class="small">Gamified Behavioral Demo â€” live model integration</div>
    </header>

    <div class="left">
        <div class="hero card">
            <div style="flex:1">
                <div style="font-weight:700; font-size:20px">Start your Forge â€” Market Simulation</div>
                <div class="small" style="margin-top:6px">This panel simulates short sessions. Make decisions (Buy /
                    Hold / Sell) when events appear.
                    The model will classify your risk-style at session end.
                </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px; align-items:center">
                <button id="startSession" class="bigbtn">Start Session</button>
                <button id="endSession" class="bigbtn" style="background:#2dd4bf">End Session & Predict</button>
            </div>
        </div>

        <div class="card stage">
            <div class="event-box" id="eventBox">
                <div class="event-title" id="eventTitle">Press <b>Start Session</b> to begin</div>
                <div class="event-sub" id="eventSub">Game events will appear here â€” react quickly.</div>

                <div class="controls">
                    <button class="action" id="buyBtn">Buy</button>
                    <button class="safe" id="sellBtn">Sell</button>
                    <button class="action" id="holdBtn">Hold</button>
                </div>

                <div class="metrics">
                    <div class="metric">
                        <div class="small">Reaction (ms)</div>
                        <div id="rtime">â€”</div>
                    </div>
                    <div class="metric">
                        <div class="small">HighRisk</div>
                        <div id="hrCount">0</div>
                    </div>
                    <div class="metric">
                        <div class="small">Safe</div>
                        <div id="safeCount">0</div>
                    </div>
                    <div class="metric">
                        <div class="small">Points</div>
                        <div id="points">0</div>
                    </div>
                </div>

                <div class="controls2">
                    <div class="row">
                        <div class="small">Impulse</div>
                        <input id="impulse" type="range" min="0" max="100" value="30"/>
                    </div>
                    <div class="row">
                        <div class="small">Social</div>
                        <input id="social" type="range" min="0" max="100" value="20"/>
                    </div>
                    <div class="row">
                        <div class="small">Debt ratio</div>
                        <input id="debt" type="range" min="0" max="100" value="10"/>
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:12px; margin-top:12px">
                <div class="card" style="flex:1; padding:12px">
                    <div style="font-weight:700">Active Forger</div>
                    <div class="small">Choose a Forge</div>
                    <div class="forge-row">
                        <div class="forge">
                            <div style="opacity:0.9">Market Forge</div>
                            <div class="small">Investing & trading</div>
                        </div>
                        <div class="forge">
                            <div style="opacity:0.9">Budgeting Forge</div>
                            <div class="small">Personal finance</div>
                        </div>
                        <div class="forge">
                            <div style="opacity:0.9">Digital Forge</div>
                            <div class="small">FinTech</div>
                        </div>
                    </div>
                </div>

                <div class="card" style="width:260px; padding:12px">
                    <div style="font-weight:700">Quick Controls</div>
                    <div style="margin-top:8px" class="small">Reward points adjust game score</div>
                    <div style="display:flex;gap:8px;margin-top:8px">
                        <button onclick="addPoints(20)" class="small">+20 pts</button>
                        <button onclick="addPoints(50)" class="small">+50 pts</button>
                    </div>
                    <div style="margin-top:10px" class="small">Loss Aversion</div>
                    <input id="loss" type="range" min="0" max="100" value="40"/>
                </div>
            </div>
        </div>
    </div>

    <aside class="right">
        <div class="card analytics">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <div style="font-weight:700">Behavioral Analytics Engine</div>
                <div class="small">Live session metrics</div>
            </div>

            <div style="margin-top:12px">
                <div class="small">Reaction Time</div>
                <div class="bar"><i id="barReaction" style="width:10%"></i></div>

                <div class="small">Risk Taking</div>
                <div class="bar"><i id="barRisk" style="width:10%"></i></div>

                <div class="small">Trading Frequency</div>
                <div class="bar"><i id="barFreq" style="width:10%"></i></div>

                <div class="small">Debt Prioritization</div>
                <div class="bar"><i id="barDebt" style="width:10%"></i></div>
            </div>

            <div class="result" id="apiResult">
                <div style="font-weight:700">Prediction</div>
                <div id="predText" class="small">No prediction yet</div>
            </div>
        </div>

        <div class="card badge" style="padding:14px">
            <div class="dot">ðŸ”¥</div>
            <div>
                <div style="font-weight:700" id="badgeTitle">No Profile</div>
                <div class="small" id="badgeDesc">Play a session to get a behavioral badge</div>
            </div>
        </div>
    </aside>

    <footer>
        <div class="small">Demo â€” open `finforge_demo_frontend.html` while Flask server is running
            (http://127.0.0.1:5000/predict)
        </div>
    </footer>
</div>

<script>
    /* Demo game logic + API call */
    let running = false;
    let eventTimer = null;
    let eventStart = 0;
    let reactionTimes = [];
    let highRisk = 0, safeMoves = 0, points = 0;
    let freqCount = 0;
    let sessionStart = 0;
    let lastHoldTime = null;

    const eventBox = document.getElementById('eventBox');
    const eventTitle = document.getElementById('eventTitle');
    const eventSub = document.getElementById('eventSub');
    const rtimeEl = document.getElementById('rtime');
    const hrCountEl = document.getElementById('hrCount');
    const safeCountEl = document.getElementById('safeCount');
    const pointsEl = document.getElementById('points');

    const barReaction = document.getElementById('barReaction');
    const barRisk = document.getElementById('barRisk');
    const barFreq = document.getElementById('barFreq');
    const barDebt = document.getElementById('barDebt');

    const predText = document.getElementById('predText');
    const badgeTitle = document.getElementById('badgeTitle');
    const badgeDesc = document.getElementById('badgeDesc');

    document.getElementById('startSession').onclick = startSession;
    document.getElementById('endSession').onclick = endSession;

    document.getElementById('buyBtn').onclick = () => handleAction('buy');
    document.getElementById('sellBtn').onclick = () => handleAction('sell');
    document.getElementById('holdBtn').onclick = () => handleAction('hold');

    function startSession() {
        if (running) return;
        running = true;
        sessionStart = Date.now();
        reactionTimes = [];
        highRisk = 0;
        safeMoves = 0;
        points = 0;
        freqCount = 0;
        updateUI();
        nextEvent();
        eventTimer = setInterval(nextEvent, 6000); // new event every 6s
        eventTitle.innerText = "Session started â€” react to events";
        eventSub.innerText = "Events will appear automatically. Use Buy/Hold/Sell.";
    }

    function endSession() {
        if (!running) return;
        running = false;
        clearInterval(eventTimer);
        eventTitle.innerText = "Session ended â€” preparing prediction...";
        eventSub.innerText = "Sending data to model...";

        // aggregate features
        const session_length_sec = Math.round((Date.now() - sessionStart) / 1000);
        const reaction_time_ms = reactionTimes.length ? Math.round(median(reactionTimes)) : 1200;
        const high_risk_moves = highRisk;
        const safe_moves = safeMoves;
        const avg_hold_time_sec = lastHoldTime ? Math.round((Date.now() - lastHoldTime) / 1000) : 30;
        const debt_ratio = document.getElementById('debt').value / 100;
        const spend_impulse_score = document.getElementById('impulse').value / 100;
        const social_sentiment_influence = document.getElementById('social').value / 100;
        const loss_aversion_score = document.getElementById('loss').value / 100;
        const reward_points = points;
        const market_volatility = currentEvent ? currentEvent.vol : Math.random();
        const news_sentiment = currentEvent ? currentEvent.sent : (Math.random() - 0.5);

        // âœ… payload adapted to backend/CSV schema
        const payload = {
            user_id: "demo_player_01",
            session_id: crypto.randomUUID(),

            market_volatility: market_volatility,
            news_sentiment: news_sentiment,
            reaction_time_ms: reaction_time_ms,
            high_risk_moves: high_risk_moves,
            safe_moves: safe_moves,
            social_follow_score: social_sentiment_influence,
            impulse_buy_score: spend_impulse_score,
            loss_aversion_score: loss_aversion_score,
            debt_ratio: debt_ratio,
            reward_points: reward_points
        };

        // call API
        fetchPrediction(payload);
        updateUI();
    }

    /* small utility */
    function median(arr) {
        arr = arr.slice().sort((a, b) => a - b);
        if (!arr.length) return 0;
        const mid = Math.floor(arr.length / 2);
        return arr.length % 2 ? arr[mid] : (arr[mid - 1] + arr[mid]) / 2;
    }

    /* events & actions */
    const eventTypes = [
        {title: "Bull Run", desc: "Prices trending up", vol: 0.3, sent: 0.5},
        {title: "Market Crash", desc: "Sudden drop", vol: 0.9, sent: -0.8},
        {title: "Stable Market", desc: "Quiet market", vol: 0.1, sent: 0.1},
        {title: "FOMO Alert", desc: "Hype trending", vol: 0.6, sent: 0.7},
        {title: "News Event", desc: "Breaking news", vol: 0.7, sent: -0.4}
    ];
    let currentEvent = null;

    function nextEvent() {
        if (!running) return;
        const ev = eventTypes[Math.floor(Math.random() * eventTypes.length)];
        currentEvent = {...ev};
        eventTitle.innerText = ev.title;
        eventSub.innerText = ev.desc + " â€” Vol:" + ev.vol.toFixed(2);
        eventStart = Date.now();
    }

    function handleAction(action) {
        if (!running) return;
        const now = Date.now();
        const react = now - eventStart;
        reactionTimes.push(react);
        rtimeEl.innerText = Math.round(react);
        freqCount++;
        if (action === 'buy') {
            highRisk++;
            points += 20;
        } else if (action === 'sell') {
            safeMoves++;
            points += 8;
        } else {
            points += 4;
            lastHoldTime = now;
        }
        hrCountEl.innerText = highRisk;
        safeCountEl.innerText = safeMoves;
        pointsEl.innerText = points;

        // small visual update
        updateUI();
    }

    /* UI update: set bar widths from metrics (normalized) */
    function updateUI() {
        const rt = reactionTimes.length ? median(reactionTimes) : 1200;
        const rtPct = Math.min(100, Math.round(100 * (1200 - rt) / 1000 + 20));
        barReaction.style.width = Math.max(6, rtPct) + '%';

        const riskPct = Math.min(100, 10 + highRisk * 10 + (document.getElementById('impulse').value / 10));
        barRisk.style.width = riskPct + '%';

        const freqPct = Math.min(100, freqCount * 8 + 8);
        barFreq.style.width = freqPct + '%';

        const debtPct = Math.min(100, document.getElementById('debt').value);
        barDebt.style.width = debtPct + '%';
    }

    /* add points helper */
    function addPoints(n) {
        points += n;
        pointsEl.innerText = points;
        updateUI();
    }

    /* API call */
    async function fetchPrediction(payload) {
        // show interim
        predText.innerText = "Calling model...";
        try {
            const res = await fetch("http://127.0.0.1:5000/predict", {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error("HTTP " + res.status);
            const j = await res.json();

            // The API may return predicted_profile as number or string; handle both.
            let profile = j.predicted_profile ?? j.profile ?? j.predicted ?? j;
            // If numeric string, try to map via classes if available
            if (typeof profile === 'number') {
                // API earlier returns encoded ints or strings; show as-is
                profile = String(profile);
            }

            // show probabilities if available
            const probs = j.probabilities ?? j.probabilities ?? j.probs ?? null;

            predText.innerText = "Profile: " + profile + (probs ? ("\n\nProbabilities:\n" + JSON.stringify(probs, null, 2)) : "");

            // update badge UI mapping (simple)
            const p = profile.toString().toLowerCase();
            if (p.includes("fomo") || p.includes("fomo_susceptible")) {
                badgeTitle.innerText = "FOMO-Susceptible";
                badgeDesc.innerText = "Makes impulsive decisions based on hype.";
            } else if (p.includes("high") && p.includes("frequency") || p.includes("hf_trader") || p.includes("high_frequency")) {
                badgeTitle.innerText = "High-Frequency Trader";
                badgeDesc.innerText = "Rapid trades with limited analysis.";
            } else if (p.includes("conservative")) {
                badgeTitle.innerText = "Conservative Planner";
                badgeDesc.innerText = "Prefers stable, long-term strategies.";
            } else if (p.includes("moderate")) {
                badgeTitle.innerText = "Moderate Investor";
                badgeDesc.innerText = "Balanced risk appetite.";
            } else if (p.includes("high_risk") || p.includes("highrisk")) {
                badgeTitle.innerText = "High-Risk Trader";
                badgeDesc.innerText = "Seeks aggressive opportunities.";
            } else {
                badgeTitle.innerText = String(profile);
                badgeDesc.innerText = "Model output â€” check probabilities for detail.";
            }

        } catch (err) {
            predText.innerText = "Prediction failed: " + err;
            badgeTitle.innerText = "Offline";
            badgeDesc.innerText = "Unable to reach model API.";
        }
    }

    /* small: begin with UI update every second */
    setInterval(updateUI, 800);

</script>
</body>
</html>


