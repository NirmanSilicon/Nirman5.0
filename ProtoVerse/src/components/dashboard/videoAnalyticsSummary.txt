"use client";

import React from 'react';
import { AlertTriangle, Eye, Users, MousePointer, UserX } from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { MotionViolation } from '@/types/response';

interface VideoAnalyticsSummaryProps {
  motionViolations?: number;
  faceDetectionWarnings?: number;
  videoMetadata?: {
    hasVideo: boolean;
    videoDuration?: number;
    motionViolations?: MotionViolation[];
    noFaceDetectedCount?: number;
    multipleFacesCount?: number;
    lookingAwayCount?: number;
    suspiciousMovementCount?: number;
  };
}

export function VideoAnalyticsSummary({
  motionViolations = 0,
  faceDetectionWarnings = 0,
  videoMetadata,
}: VideoAnalyticsSummaryProps) {
  if (!videoMetadata?.hasVideo) {
    return (
      <Card>
        <CardHeader>
          <CardTitle className="text-sm">Video Monitoring</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-sm text-gray-500">Video was not enabled for this interview</p>
        </CardContent>
      </Card>
    );
  }

  const getSeverityColor = (total: number) => {
    if (total === 0) return 'bg-green-100 text-green-800';
    if (total <= 3) return 'bg-yellow-100 text-yellow-800';
    if (total <= 7) return 'bg-orange-100 text-orange-800';
    return 'bg-red-100 text-red-800';
  };

  const getSeverityLabel = (total: number) => {
    if (total === 0) return 'Clean';
    if (total <= 3) return 'Low Risk';
    if (total <= 7) return 'Medium Risk';
    return 'High Risk';
  };

  const totalViolations = motionViolations + faceDetectionWarnings;

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between">
          <CardTitle className="text-sm">Video Monitoring Report</CardTitle>
          <Badge className={getSeverityColor(totalViolations)}>
            {getSeverityLabel(totalViolations)}
          </Badge>
        </div>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {/* Summary Stats */}
          <div className="grid grid-cols-2 gap-4">
            <div className="flex items-center gap-2">
              <AlertTriangle className="w-4 h-4 text-orange-500" />
              <div>
                <p className="text-xs text-gray-500">Total Violations</p>
                <p className="text-lg font-bold">{totalViolations}</p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <Eye className="w-4 h-4 text-blue-500" />
              <div>
                <p className="text-xs text-gray-500">Duration</p>
                <p className="text-lg font-bold">
                  {Math.floor((videoMetadata.videoDuration || 0) / 60)}m {(videoMetadata.videoDuration || 0) % 60}s
                </p>
              </div>
            </div>
          </div>

          {/* Detailed Breakdown */}
          <div className="space-y-2 pt-4 border-t">
            <p className="text-xs font-semibold text-gray-700 mb-2">Violation Breakdown:</p>
            
            <ViolationItem
              icon={<UserX className="w-4 h-4" />}
              label="No Face Detected"
              count={videoMetadata.noFaceDetectedCount || 0}
              description="Candidate not visible in camera"
            />
            
            <ViolationItem
              icon={<Users className="w-4 h-4" />}
              label="Multiple Faces"
              count={videoMetadata.multipleFacesCount || 0}
              description="Additional person(s) detected"
            />
            
            <ViolationItem
              icon={<Eye className="w-4 h-4" />}
              label="Looking Away"
              count={videoMetadata.lookingAwayCount || 0}
              description="Candidate not facing camera"
            />
            
            <ViolationItem
              icon={<MousePointer className="w-4 h-4" />}
              label="Suspicious Movement"
              count={videoMetadata.suspiciousMovementCount || 0}
              description="Rapid or unusual movement detected"
            />
          </div>

          {/* Recent Violations Timeline */}
          {videoMetadata.motionViolations && videoMetadata.motionViolations.length > 0 && (
            <div className="pt-4 border-t">
              <p className="text-xs font-semibold text-gray-700 mb-2">Recent Violations:</p>
              <div className="space-y-1 max-h-40 overflow-y-auto">
                {videoMetadata.motionViolations.slice(-5).reverse().map((violation, index) => (
                  <div key={index} className="text-xs bg-gray-50 p-2 rounded">
                    <span className="font-medium">
                      {new Date(violation.timestamp).toLocaleTimeString()}
                    </span>
                    {' - '}
                    <span className="text-gray-600">{violation.description}</span>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
}

interface ViolationItemProps {
  icon: React.ReactNode;
  label: string;
  count: number;
  description: string;
}

function ViolationItem({ icon, label, count, description }: ViolationItemProps) {
  return (
    <div className="flex items-center justify-between p-2 rounded bg-gray-50">
      <div className="flex items-center gap-2">
        <div className="text-gray-600">{icon}</div>
        <div>
          <p className="text-xs font-medium">{label}</p>
          <p className="text-xs text-gray-500">{description}</p>
        </div>
      </div>
      <Badge variant={count > 0 ? "destructive" : "secondary"}>
        {count}
      </Badge>
    </div>
  );
}
